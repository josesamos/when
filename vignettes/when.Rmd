---
title: "Generating the *When Dimension* based on date and time tables"
date: "2023-12-26"
output: rmarkdown::html_vignette
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Generating the *When Dimension* based on date and time tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The *When Dimension* plays a fundamental role in *Multidimensional Systems*, it allows us to express **when** the analysed focus of attention have occurred.

This dimension corresponds to the generically called “Time Dimension”, as named in @kimball1996data and @adamson2010star. Later it has also been called "Date Dimension" or "Time Dimension" to express granularity [@kimball2013data]. We prefer to call it "When Dimension" because granularity is not involved in that term.

Although conceptually the date and time can be represented together in a single dimension, in ROLAP (*Relational On-Line Analytical Processing*) systems, it is common to implement these concepts separately, sometimes in separate tables "to avoid a row count explosion in the date dimension" [@kimball2013data] by adding the time for each day.

In @kimball2013data these dimensions are considered *static dimensions*: they are built at the beginning of the project for the period under consideration and are referenced when adding the instances to the fact table. As mentioned there: "Typically, these dimensions are built in an afternoon with a spreadsheet."

The purpose of the `when` package is to assist in the implementation of the ***When Dimension*** in Multidimensional Systems implemented on a ROLAP star database, regardless of its granularity, with the following features:

- It supports the generation of tables with the granularity needed (second, minute, hour, date, week, month or year). 

- We consider separate tables for **time** data and data obtained from **date** to avoid a row count explosion if a single table were used. 

- It can be used to generate tables **statically**, indicating a period, or **dynamically**, indicating data series. 

- In addition to attributes at the selected granularity, other attributes can be added at coarser granularity to facilitate querying.

The rest of this document is structured as follows: First, the general process of defining dimensions is presented. Next, a section is dedicated to the definition of dimensions based on time and another to dimensions based on date. Finally, the document ends with conclusions and bibliography.

# Definition process

The definition process begins by creating an object of the `when` class.

```{r setup}
library(when)

w_date <- when()
```

By default, an object is created based on date, but we can also create it based on time by indicating it using the `type` parameter.

```{r}
w_time <- when(type = 'time')
```

Virtually all configuration options can be defined using the object creation function. They can also be defined later using specific functions. For example, using the following combination of functions we obtain the same result.

```{r}
w_time_2 <- when() |>
  configure_dimension(type = 'time')

identical(w_time, w_time_2)
```

As with the date, we can indicate specific time periods or a vector of times to consider.


## Definition of instances

We can define the instances by giving a range of values or by indicating the specific instances. The values in both cases will depend on the type of dimension (date-based or time-based).

We can indicate these values at the time of creating the class object or through the `define_instances()` configuration function.

- In the case of date, we can indicate a year, year and month (with the format `yyyy-mm`), or year month and day (`yyyy-mm-dd`).

- In the case of time, we can indicate an hour, hour and minute (with the format `hh:mm`), or hour, minute and second (`hh:mm:ss`).

In both cases we can use the string format, the one provided by the [`lubridate`](https://CRAN.R-project.org/package=lubridate) package or, when it is a single number (year or hour) we can use an integer value. Then it will be transformed appropriately.

```{r}
w_date <- w_date |>
  define_instances(start = lubridate::today(),
                   end = lubridate::today() + lubridate::years(5))
```

The following definition will be appropriate if we want to obtain the dimension at the year level, because we are indicating the specific values to consider.

```{r}
w_date_2 <- w_date |>
  define_instances(values = 2020:2030)
```

The following definition will be appropriate at any level of detail because we are giving the range of values to consider (dates between those two years).

```{r}
w_date_3 <- w_date |>
  define_instances(start = 2020, end = 2030)
```

When only the year is indicated, it is considered its first day. Therefore the previous definition is equivalent to the following one.

```{r}
w_date_4 <- w_date |>
  define_instances(start = "2020-01-01", end = "2030-01-01")

identical(w_date_3, w_date_4)
```

In the case of time, by default, it is considered at the second level and all seconds of the day.

```{r}
w_time_3 <- w_time |>
  define_instances(start = "00:00:00", end = "23:59:59")

identical(w_time, w_time_3)
```


## Selection and definition of levels

In the definition, by default, the attributes that we have considered to be most frequently used have been included. We can consult them using the `get_table_attribute_names()` function.

```{r}
w_date |>
  get_table_attribute_names(as_string = FALSE)

w_time |>
  get_table_attribute_names(as_string = FALSE)

w_time |>
  get_table_attribute_names()
```

Although we have not yet generated the dimension table, this function returns the names of the attributes it will contain. They can be obtained as a string or as a vector of strings.

This function is very useful when we already know the attributes. If it is generated in the form of a string (`as_string = TRUE`, default option), the result can be used to easily change the name of the attributes, when the table is generated, using the `set_table_attribute_names()` function.

## Generation of the result

## Table export

# Time based dimension

# Date based dimension

# Conclusions

`when` package offers a set of operations that allow us to transform tables into star databases.  From several star databases you can define a constellation with conformed dimensions.

Operations have been designed to be intuitive and easy to use. The result greatly facilitates the data transformation process for the exposed situation.

The implementation of the multidimensional database obtained can be exported to work with multidimensional analysis tools on spreadsheets or RDBMS.

# Bibliography

